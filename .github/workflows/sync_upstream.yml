name: Sync & Build Complications Branch

on:
  # Run weekly on Sunday at 2am UTC (gives time for upstream weekend releases)
  schedule:
    - cron: '0 2 * * 0'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      upstream_branch:
        description: 'Upstream branch to sync from'
        required: true
        default: 'dev'
        type: string
      trigger_build:
        description: 'Trigger TestFlight build after sync'
        required: false
        default: true
        type: boolean

# Explicit permissions
permissions:
  contents: write
  pull-requests: write
  actions: write

env:
  UPSTREAM_REPO: nightscout/Trio
  UPSTREAM_BRANCH: ${{ github.event.inputs.upstream_branch || 'dev' }}
  # Your branch with complications code
  TARGET_BRANCH: claude/add-watch-complications-Mnd9b

jobs:
  sync:
    runs-on: ubuntu-latest
    outputs:
      synced: ${{ steps.merge.outputs.merge_success }}
      had_changes: ${{ steps.check_changes.outputs.has_changes }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TARGET_BRANCH }}
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git || true
          git fetch upstream ${{ env.UPSTREAM_BRANCH }}

      - name: Check for upstream changes
        id: check_changes
        run: |
          UPSTREAM_COMMITS=$(git rev-list HEAD..upstream/${{ env.UPSTREAM_BRANCH }} --count)
          echo "commit_count=$UPSTREAM_COMMITS" >> $GITHUB_OUTPUT

          if [ "$UPSTREAM_COMMITS" -gt "0" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "üì¶ Found $UPSTREAM_COMMITS new commits from upstream"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Already up to date with upstream"
          fi

      - name: Attempt merge
        id: merge
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "Attempting to merge upstream/${{ env.UPSTREAM_BRANCH }}..."

          if git merge upstream/${{ env.UPSTREAM_BRANCH }} -m "Merge upstream ${{ env.UPSTREAM_BRANCH }} into complications branch"; then
            echo "merge_success=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Merge successful!"
          else
            echo "merge_success=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Merge has conflicts"
            git merge --abort
          fi

      - name: Push if merge succeeded
        if: steps.merge.outputs.merge_success == 'true'
        run: |
          git push origin ${{ env.TARGET_BRANCH }}
          echo "‚úÖ Successfully synced with upstream!"

      - name: Create PR if conflicts
        if: steps.merge.outputs.merge_success == 'false'
        run: |
          # Create a temporary branch with upstream changes
          SYNC_BRANCH="sync-upstream-$(date +%Y%m%d-%H%M)"
          git checkout -b $SYNC_BRANCH upstream/${{ env.UPSTREAM_BRANCH }}
          git push -u origin $SYNC_BRANCH

          # Create PR using GitHub CLI with heredoc for body
          gh pr create \
            --base ${{ env.TARGET_BRANCH }} \
            --head $SYNC_BRANCH \
            --title "Sync upstream Trio changes (conflicts need resolution)" \
            --body "$(cat <<'PRBODY'
          ## Upstream Sync Required

          Merge conflicts were detected and need manual resolution.

          ### Likely conflict locations:
          - FreeAPS.xcodeproj/project.pbxproj - Re-add ComplicationData.swift references
          - FreeAPSWatch WatchKit Extension/WatchStateModel.swift - Keep the updateComplicationData() call

          ### Your custom files (should not conflict):
          - ComplicationData.swift - Smart update manager
          - ComplicationController.swift - Live glucose complications

          ### After resolving conflicts:
          1. Keep all your Watch complication code
          2. Accept upstream changes for everything else
          3. Merge this PR to trigger a build
          PRBODY
          )"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Summary
        run: |
          echo "## üîÑ Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "false" ]; then
            echo "‚úÖ Already up to date with upstream - no sync needed." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.merge.outputs.merge_success }}" == "true" ]; then
            echo "‚úÖ Successfully merged ${{ steps.check_changes.outputs.commit_count }} commits from upstream." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Merge conflicts detected. A PR has been created for manual resolution." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please resolve conflicts and merge the PR to continue." >> $GITHUB_STEP_SUMMARY
          fi

  # Trigger the existing build workflow after successful sync
  trigger-build:
    needs: sync
    if: |
      github.event.inputs.trigger_build != 'false' &&
      (needs.sync.outputs.synced == 'true' || needs.sync.outputs.had_changes == 'false')
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Build Workflow
        run: |
          echo "üöÄ Triggering build workflow for branch: ${{ env.TARGET_BRANCH }}"

          gh workflow run "build_trio.yml" \
            --repo ${{ github.repository }} \
            --ref ${{ env.TARGET_BRANCH }}

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üöÄ Build Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build workflow started for \`${{ env.TARGET_BRANCH }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View build progress](https://github.com/${{ github.repository }}/actions)" >> $GITHUB_STEP_SUMMARY
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
